
# ROM contents

This folder contains files and code to build a ROM image that can be burned into the 512k ROM on the board, so that it actually boots.

- iplldr.a65: initial program loader, boots the machine by:
-- copying over character ROM image from start of ROM ($0f0000) to start of bank 7 (in RAM)
-- letting the user select which machine to boot (BASIC 2, BASIC 4/40 columns, BASIC 4/80 columns)
-- copying over selected PET ROM image to bank 0 ($a000-$ffff) ...
-- and executes a JMP through the RESET vector

For this work the ROM needs to contain:
- boot code
- character ROM
- system ROMs

## SPI FLash Memory Map

The IPL triggered by the CPLD loads the first 256 byte from the SPI flash. Following that is the
rest of the boot code as loaded by the initial IPL loader.
Then follow the various ROM images.

	Boot Image
        
        +----+ $1ffff
        |    |
         ...           free
        |    |
        +----+ $1a000
        |    |         BASIC 1 alternate charrom 
        |    |         (as 16 byte/char)
        +----+ $18000
        |    |         8x BASIC 4 EDITOR
         ...           ROM images ($e000-$efff)
        |    |         Extended/orig, 40/80 columns, N-type/C64 kbd
        |    |
        +----+ $10000
        |    |         BASIC 4 Kernal ROM image
        +----+ $0F000
        |    |         BASIC 4 
        |    |         ROM image ($b000-$dfff)
        |    |         
        +----+ $0c000
        |    |         BASIC 2 
        |    |         ROM image ($c000-$ffff)
        |    |  
        |    |       
        +----+ $08000
        |    |         BASIC 1 
        |    |         ROM image ($c000-$ffff)
        |    |
        |    |
        +----+ $04000
        |    |         8k PET charrom
        |    |         (16 byte per character)
        +----+ $02000
        |    |         4k @MON in the PET4 variant (without editor extension)
        +----+ $01000
        |    |         Boot loader, first 256 byte IPL's by CPLD
        +----+ $00000

## Build

To build the ROM, just run "make".
This build process for bootimg downloads the necessary ROM images from the internet, builds the boot loader, and combines everything into a single boot image.
Then burn the resulting file "spiimg" into the lowest bank of the SPI Flash ROM (Address 0)

## Files

The following files are test files, or to build the ROMs:

- char8to16.c: converts a character ROM with 8 pixel rows per character to a 16 row per character image
- charPet2Invers.c: a PET charrom is only 2k and lacks inverted characters, as they are generated by hardware. This small program creates, from the 2k PET image, a full 4k image that contains the inverted characeters
- edit....asm: control files for Steve Gray's editor ROM project, to build the custom editor ROMs
-- edit40gx: 40 column for graphics keyboard with wedge and special keys
-- edit80gx: 80 column for graphics keyboard with wedge and special keys
-- edit40gxc: 40 column for C64 keyboard with wedge and special keys
-- edit80gxc: 80 column for C64 keyboard with wedge and special keys
-- edit40gc: 40 column for C64 keyboard (no further extensions) 
-- edit80gc: 80 column for C64 keyboard (no further extensions)

## ROM features

The editor ROMs are non-standard, and feature some extensions.
Note that they are only available for BASIC 4 variants. BASIC 1 and 2 are only just that.

### Extended versus Base ROMs

In the boot menu you can select the various model. By default the 
extended editor ROM is loaded where available (i.e. including wedge and special keys).
If you select the model while pressing the LEFT SHIFT, the unmodified ROM
is loaded. One exception: there is no original 80 column N-type keyboard ROM, so 
a contemporary adaption is used.

The BASIC 1 Kernal has the problem that its IEEE488 routines are broken.
Therefore, by default, a version that is patched to fix this is loaded,
so IEEE488 can be used. Selecting "1" with LEFT-SHIFT pressed installs
the original BASIC 1 ROMs.

Note that pressing the RIGHT SHIFT is not what you want. Doing this on the
N-type keyboard makes the select routing think you are using a C64 keyboard
instead, and the machine becomes unusable.

### Graphics keyboard ROMs

These are derived from the standard PET ROMs, but feature some extensions:

1. Shift + '@': switch between text and graphics display.
1. '@' + Left-Shift + Right-Shift + DEL: reset the PET

### C64 keyboard ROMs

The ...gc ROM files enable the use of a C64 keyboard instead of a PET graphics keyboard. 
The initial boot loader, where the model is selected detects the keyboard used using the numbers
pressed to select the model, and automatically loads the correct ROM.

Note that due to code size restrictions, only the normal and shifted keys are supported. CBM and Control
are currently ignored.

The follwing features are present:

1. Shift + Left-Arrow: switch between text and graphics display.
1. Ctrl + Left-Shift + Right-Shift + DEL: reset the PET

### Extended machine language monitor

In the ROM area at $a000 there is the @MON machine language monitor included (with assembler
and disassembler, and versatile search functions). 

Note that the scrolling editor is (for now) disabled due to incompatibilities with the modified
editor ROMs.

