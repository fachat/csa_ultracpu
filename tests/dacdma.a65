

	.word $0401
	*=$0401

	.word link
	.word 10
	.byt $9e, "1040",0
link	.word 0

	.dsb 1040-*

DAC_BASE	=$e830

DAC_START	=0	; 3 registers, 2x8+3 bits
DAC_LEN		=3	; 2 registers, 2x8 bits
DAC_RATE	=5	; 2 registers, 8/4 bits
DAC_WP		=10	
DAC_RP		=11
DAC_CH0		=12
DAC_CH1		=13
DAC_CTRL	=15

DAC_CTRL_ACTIVE	=%10000000
DAC_CTRL_CHAN	=%00000100
DAC_CTRL_STEREO	=%00000010
DAC_CTRL_LOOP	=%00000001

DATA		=$9400	; screen mem in video bank for testing
LEN		=$0100
RATE		=37

CDATA		=$8400; screen mem in CPU space

start	.(
	
	; init DMA start pointer
	lda #<DATA
	sta DAC_BASE + DAC_START
	lda #>DATA
	sta DAC_BASE + DAC_START + 1
	lda #0
	sta DAC_BASE + DAC_START + 2

	; init DMA data length
	lda #<LEN
	sta DAC_BASE + DAC_LEN
	lda #>LEN
	sta DAC_BASE + DAC_LEN + 1

	; init DMA rate; 
	;
	; base freq is 12MHz/16 = 750kHz
	; multiplied by rate value is rate data
	; is sent out to DAC.
	; rate 17 = 44100 Hz
	; rate 37 = 20270 Hz
	; ..
	lda #<RATE
	sta DAC_BASE + DAC_RATE
	lda #>RATE
	sta DAC_BASE + DAC_RATE + 1

	; set up ram data
	ldx #0
l1	txa
	sta CDATA,x
	eor #$ff
	inx
	sta CDATA,x
	inx
	bne l1

	lda #0
	sta DAC_BASE + DAC_CH0
	sta DAC_BASE + DAC_CH1

	;jsr wait

	lda #41
	sta 59520
	inc 59521	; border col

	lda #DAC_CTRL_ACTIVE + DAC_CTRL_STEREO
	sta DAC_BASE + DAC_CTRL
	rts

wait	.(
	ldy #0
	ldy #0
l0	dey
	bne l0
	dex
	bne l0
	rts
	.)

	.)

